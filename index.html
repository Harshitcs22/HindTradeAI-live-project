<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HindTradeAI - Nexus Interface</title>
    <style>
        /* --- TUMHARA UI DESIGN --- */
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: #0f172a; color: white; display: flex; flex-direction: column; min-height: 100vh; }
        .hero { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        h1 { font-size: 3rem; background: linear-gradient(to right, #38bdf8, #818cf8); -webkit-background-clip: text; color: transparent; margin: 0; }
        p { color: #94a3b8; margin-top: 10px; }

        .chat-widget-btn { position: fixed; bottom: 20px; right: 20px; background: #38bdf8; color: white; border: none; border-radius: 50%; width: 60px; height: 60px; cursor: pointer; font-size: 24px; box-shadow: 0 4px 15px rgba(56, 189, 248, 0.4); }
        
        .chat-container { display: flex; position: fixed; bottom: 90px; right: 20px; width: 380px; height: 500px; background-color: #1e293b; border-radius: 12px; border: 1px solid #334155; flex-direction: column; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .chat-header { background: #0f172a; padding: 15px; border-bottom: 1px solid #334155; font-weight: bold; color: #38bdf8; display: flex; justify-content: space-between; }
        .close-btn { background: none; border: none; color: #fff; cursor: pointer; font-size: 18px; }
        
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .message { padding: 10px; border-radius: 8px; max-width: 85%; font-size: 0.9rem; line-height: 1.4; }
        .bot-message { background: #334155; align-self: flex-start; border-left: 3px solid #38bdf8; }
        .user-message { background: #38bdf8; color: #0f172a; align-self: flex-end; }
        
        .chat-input { padding: 15px; background: #0f172a; display: flex; gap: 10px; border-top: 1px solid #334155; }
        .chat-input input { flex: 1; background: #334155; border: none; padding: 10px; border-radius: 6px; color: white; outline: none; }
        .chat-input button { background: #38bdf8; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; }

        /* DEBUG LOG (Hidden by default, dikhega agar error aya) */
        .debug-log { font-size: 0.7rem; color: #ff6b6b; margin-top: 5px; font-family: monospace; display: block; }
    </style>
</head>
<body>

    <div class="hero">
        <h1>HindTrade AI</h1>
        <p>System Connected.</p>
    </div>

    <button class="chat-widget-btn" onclick="toggleChat()">ðŸ’¬</button>

    <div class="chat-container" id="chatBox">
        <div class="chat-header">
            <span>Nexus Agent</span>
            <button class="close-btn" onclick="toggleChat()">Ã—</button>
        </div>
        <div class="chat-body" id="messages">
            <div class="message bot-message">Hello! I'm online.</div>
        </div>
        <div class="chat-input">
            <input type="text" id="userInput" placeholder="Type here..." onkeypress="handleEnter(event)">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CONFIG = {
            REGION_URL: "https://api-d7b62b.stack.tryrelevance.com/latest",
            AGENT_ID: "a3f0bb17-9cbf-4d17-88cc-c1a981deabdd",
            // Ye API Key tumhari purani wali hai, agar change ki hai to replace kar dena
            AUTH: "3fdb8425-c0a5-4909-9513-21d07c9f8f99:sk-NmQwOGI3YmMtMzljYy00NTAwLTgwYTUtYzE0NzRiYzA0N2Rh"
        };

        function toggleChat() {
            const box = document.getElementById('chatBox');
            box.style.display = (box.style.display === 'none') ? 'flex' : 'none';
        }

        async function sendMessage() {
            const input = document.getElementById("userInput");
            const text = input.value.trim();
            if (!text) return;

            // User Message Show karo
            appendMessage(text, "user");
            input.value = "";

            // Loading Message
            const loadingId = appendMessage("Thinking...", "bot");

            try {
                // 1. TRIGGER (Message Bhejo)
                const res = await fetch(`${CONFIG.REGION_URL}/agents/trigger`, {
                    method: "POST",
                    headers: { "Authorization": CONFIG.AUTH, "Content-Type": "application/json" },
                    body: JSON.stringify({ message: { role: "user", content: text }, agent_id: CONFIG.AGENT_ID })
                });

                const data = await res.json();
                
                // Case A: Turant Answer aa gaya
                if (data.output && data.output.answer) {
                    updateMessage(loadingId, data.output.answer);
                } 
                // Case B: Ticket (Job ID) mila -> Ab humein peecha karna padega
                else if (data.job_info && data.job_info.job_id) {
                    // YAHAN HACK HAI: 'agent_empty_chain_inline' ko hum manually handle karenge
                    const studioId = data.job_info.studio_id || "agent_empty_chain_inline"; 
                    await trackJob(data.job_info.job_id, studioId, loadingId);
                } 
                else {
                    updateMessage(loadingId, "Message sent via Backend. Check Dashboard History.");
                }

            } catch (err) {
                updateMessage(loadingId, "Error connecting.");
                console.error(err);
            }
        }

        // --- TRACKING FUNCTION (Polling) ---
        async function trackJob(jobId, studioId, msgId) {
            // Yahan hum 2 URL try karenge safety ke liye
            const url1 = `${CONFIG.REGION_URL}/studios/${studioId}/async_poll/${jobId}`;
            const url2 = `${CONFIG.REGION_URL}/jobs/${jobId}`; // Fallback URL

            let attempts = 0;
            const interval = setInterval(async () => {
                attempts++;
                try {
                    // Pehle Specific URL try karo
                    let response = await fetch(url1, { headers: { "Authorization": CONFIG.AUTH } });
                    
                    // Agar 404/Fail aye, toh Doosra URL try karo
                    if (!response.ok) {
                        response = await fetch(url2, { headers: { "Authorization": CONFIG.AUTH } });
                    }

                    if (response.ok) {
                        const job = await response.json();
                        console.log("Status:", job.status);

                        if (job.status === "done" || job.state === "completed") {
                            clearInterval(interval);
                            
                            // Answer nikalne ka tareeka
                            let ans = "Done.";
                            if (job.output) {
                                if (job.output.answer) ans = job.output.answer;
                                else if (job.output.output) ans = job.output.output;
                                else if (typeof job.output === 'string') ans = job.output;
                                else ans = JSON.stringify(job.output); // Agar object hai toh string bana do
                            }
                            
                            // Formatting fix
                            ans = ans.replace(/\n/g, "<br>").replace(/\*\*(.*?)\*\*/g, "<b>$1</b>");
                            updateMessage(msgId, ans);
                        }
                    }
                    
                    // 30 Second Timeout
                    if (attempts > 15) {
                        clearInterval(interval);
                        updateMessage(msgId, "Took too long. Please try again.");
                    }

                } catch (e) {
                    console.error("Polling error", e);
                }
            }, 2000); // 2 second mein check karo
        }

        function appendMessage(text, sender) {
            const div = document.createElement("div");
            div.className = `message ${sender === "user" ? "user-message" : "bot-message"}`;
            div.innerHTML = text;
            div.id = "msg-" + Date.now();
            document.getElementById("messages").appendChild(div);
            document.getElementById("messages").scrollTop = 10000;
            return div.id;
        }

        function updateMessage(id, text) {
            const el = document.getElementById(id);
            if (el) el.innerHTML = text;
        }

        function handleEnter(e) { if(e.key === "Enter") sendMessage(); }
    </script>
</body>
</html>
