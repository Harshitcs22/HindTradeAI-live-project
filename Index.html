    <script>
        lucide.createIcons();
        
        // üî¥ STEP 1: Yahan apni NEW API Key daalein
        const GEMINI_API_KEY = "AIzaSyBSiAd_fvf2pUmyiXLMbOAArClM-uSnjKI"; 
        
        const SUPABASE_URL = 'https://rlezzjpgisjycxrmtbmi.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJsZXp6anBnaXNqeWN4cm10Ym1pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MzU2MjUsImV4cCI6MjA4MTAxMTYyNX0.fYeTbYnCEDP8wNkqBerGT8buMWk0wK3PdTjI57dVYSY';
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        const chatBox = document.getElementById('chat-messages');
        const whatsappBox = document.getElementById('whatsapp-box');
        const whatsappLink = document.getElementById('whatsapp-link');

        function fillInput(text) {
            document.getElementById('user-input').value = text;
        }

        async function handleChat(e) {
            e.preventDefault();
            const input = document.getElementById('user-input');
            const query = input.value.trim();
            if (!query) return;

            // 1. Show User Msg
            chatBox.innerHTML += `<div class="msg-user animate-fade-in">${query}</div>`;
            input.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;

            // 2. Typing Loader
            const loadId = 'load-' + Date.now();
            chatBox.innerHTML += `
                <div id="${loadId}" class="msg-ai w-20">
                    <div class="flex gap-1 justify-center py-1">
                        <span class="w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce"></span>
                        <span class="w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce" style="animation-delay:0.2s"></span>
                        <span class="w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce" style="animation-delay:0.4s"></span>
                    </div>
                </div>`;
            chatBox.scrollTop = chatBox.scrollHeight;

            let responseText = "";

            try {
                // 3. CALL GOOGLE GEMINI API
                const prompt = `
                    You are "The Lawyer", an expert AI for Indian Exporters.
                    Current Date: 16 Dec 2025.
                    User Query: "${query}"
                    
                    Provide a structued HTML response (NO markdown code blocks, just raw HTML tags like <b>, <br>, <ul>).
                    Format exactly like this:
                    <b>Analysis for [Product Name]:</b><br><br>
                    ‚úÖ <b>HS Code:</b> [Code]<br>
                    üìâ <b>Export Duty:</b> [Percentage/Status]<br>
                    üí° <b>Compliance Tip:</b> [One sharp tip]<br>
                    
                    Keep it short, professional, and confident.
                `;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                
                // üî¥ IMPROVED ERROR CHECKING
                if (data.error) {
                    // Agar Google ne error bheja hai, to wo dikhao
                    console.error("Gemini Error:", data.error);
                    responseText = `<span class="text-red-400 font-bold">‚ö†Ô∏è Error: ${data.error.message}</span><br><span class="text-xs text-gray-500">Check API Key or Quota.</span>`;
                } else if (data.candidates && data.candidates[0].content) {
                    // Success Case
                    let rawText = data.candidates[0].content.parts[0].text;
                    responseText = rawText.replace(/```html/g, '').replace(/```/g, '');
                } else {
                    // Fallback
                    responseText = "System Busy. Please try again in 10 seconds.";
                }

            } catch (error) {
                console.error(error);
                responseText = `<span class="text-red-400">Network Error: Check your internet connection.</span>`;
            }

            // 4. Show Result
            document.getElementById(loadId).remove();
            chatBox.innerHTML += `<div class="msg-ai animate-fade-in">${responseText}</div>`;
            chatBox.scrollTop = chatBox.scrollHeight;

            // 5. Update WhatsApp Link
            if (!responseText.includes("Error")) {
                whatsappBox.classList.remove('hidden');
                whatsappLink.href = `https://wa.me/6283849492?text=I searched for "${query}" on HindTrade. I need the official documents.`;
            }
        }

        // Modal Logic Same as before
        function openModal(type) {
            document.getElementById('registrationModal').classList.remove('hidden');
            document.getElementById('userType').value = type;
        }
        function closeModal() { document.getElementById('registrationModal').classList.add('hidden'); }
        async function submitToSupabase(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.innerText = "Processing...";
            // ... (rest of logic same)
             const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const email = document.getElementById('email').value;
            try {
                await _supabase.from('ca_requests').insert([{ name, phone, email, specialization: 'User', status: 'pending' }]);
                document.getElementById('statusMsg').innerText = "Request Approved.";
                setTimeout(closeModal, 2000);
            } catch (err) { 
                document.getElementById('statusMsg').innerText = "Connection Failed."; 
            } finally { btn.innerText = "Submit Request"; }
        }
    </script>
